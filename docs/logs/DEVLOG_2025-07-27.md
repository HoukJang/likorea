# 개발 로그 - 2025년 7월 27일

## 버전 1.6.1 - CORS 문제 해결

### 수정된 문제
- **www.likorea.com 도메인에서 DB 접속 실패 문제 해결**
  - 증상: likorea.com은 정상 작동하나 www.likorea.com에서는 API 요청 실패
  - 원인: Nginx 설정에서 백엔드의 CORS 헤더를 숨기고 있었음

### 변경 사항

#### 1. 백엔드 CORS 설정 개선 (server.js)
- `credentials: true` 옵션 추가
- 쿠키 기반 인증을 위한 자격 증명 허용

```javascript
const corsOptions = {
  origin: (origin, callback) => {
    // ... origin 검증 로직
  },
  credentials: true,  // 추가됨
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
};
```

#### 2. Nginx 프록시 설정 수정 (/etc/nginx/sites-available/likorea)
- `proxy_hide_header` 지시문 제거
- 백엔드에서 전송하는 CORS 헤더가 클라이언트에 정상적으로 전달되도록 수정

변경 전:
```nginx
location /api/ {
    # ... 프록시 설정
    # 백엔드에서 CORS를 처리하도록 Nginx에서는 CORS 헤더를 숨김
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Credentials;
}
```

변경 후:
```nginx
location /api/ {
    # ... 프록시 설정
    # proxy_hide_header 제거됨
}
```

### 결과
- www.likorea.com과 likorea.com 모두에서 정상적으로 API 통신 가능
- CORS 헤더가 올바르게 전송됨:
  - `Access-Control-Allow-Origin: https://www.likorea.com`
  - `Access-Control-Allow-Credentials: true`

### 테스트 확인
```bash
# CORS 헤더 정상 전송 확인
curl -X GET -H "Origin: https://www.likorea.com" https://www.likorea.com/api/boards -I

# 응답 헤더에 포함된 CORS 관련 헤더:
# Access-Control-Allow-Origin: https://www.likorea.com
# Access-Control-Allow-Credentials: true
```

### 보안 고려사항
- 동적 CORS 설정은 likorea.com 도메인만 허용하도록 제한
- HTTPS 프로토콜만 허용하여 중간자 공격 방지
- 백엔드에서 origin 검증 로직을 통해 보안 유지

### 다음 단계
- 프론트엔드 빌드 재배포 시 두 도메인 모두에서 정상 작동 확인
- 모니터링을 통해 CORS 관련 에러 발생 여부 지속 관찰